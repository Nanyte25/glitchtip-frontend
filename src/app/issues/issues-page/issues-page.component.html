<section class="l-body l-body--full-width mat-elevation-z0">
  <header class="page-header">
    <h1 class="mat-display-1">Issues</h1>
  </header>

  <app-header-nav></app-header-nav>

  <div *ngIf="issues$ | async as issues">
    <mat-card *ngIf="!(orgHasAProject$ | async)">
      <h3>
        This organization has no projects.
      </h3>
      <p>
        To add a project to this organization, press the
        "Add&nbsp;Project"&nbsp;button.
      </p>
    </mat-card>

    <mat-card *ngIf="(orgHasAProject$ | async) && issues.length === 0">
      <h3>
        <ng-container *ngIf="multipleProjectsSelected$ | async">
          No issues have been reported to these projects.
        </ng-container>
        <ng-container *ngIf="!(multipleProjectsSelected$ | async)">
          No issues have been reported to this project.
        </ng-container>
      </h3>

      <p>
        Add an SDK to your project<ng-container
          *ngIf="multipleProjectsSelected$ | async"
          >s</ng-container
        >
        to start sending errors to GlitchTip.
      </p>
    </mat-card>

    <table
      *ngIf="issues.length > 0"
      mat-table
      [dataSource]="issues$"
      class="mat-elevation-z2"
    >
      <ng-container matColumnDef="actions">
        <th
          mat-header-cell
          colspan="3"
          *matHeaderCellDef
          class="resolved-row"
          class="table-header"
        >
          <div class="action-group">
            <div class="button-group">
              <button
                mat-flat-button
                color="primary"
                (click)="bulkMarkResolved()"
                [disabled]="(thereAreSelectedIssues$ | async) === false"
              >
                Mark as resolved
              </button>
              <button
                style="margin-left: 10px;"
                mat-stroked-button
                (click)="bulkMarkUnresolved()"
                [disabled]="(thereAreSelectedIssues$ | async) === false"
              >
                Reopen issue
              </button>
              <button
                style="margin-left: 10px;"
                mat-stroked-button
                (click)="bulkMarkIgnored()"
                [disabled]="(thereAreSelectedIssues$ | async) === false"
              >
                Ignore issue
              </button>
            </div>
            <form [formGroup]="form" (ngSubmit)="onSubmit()">
              <mat-form-field>
                <input
                  matInput
                  type="search"
                  placeholder="Search"
                  formControlName="query"
                />
              </mat-form-field>
            </form>
          </div>
        </th>
      </ng-container>

      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            (change)="toggleSelectAll()"
            [checked]="(areAllSelected$ | async)!"
          >
          </mat-checkbox>
        </th>
        <td
          mat-cell
          *matCellDef="let row"
          [class.resolved]="row.status === 'resolved'"
          [class.ignored]="row.status === 'ignored'"
        >
          <mat-checkbox
            (change)="toggleCheck(row.id)"
            [checked]="row.isSelected"
          >
          </mat-checkbox>
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
        <td
          mat-cell
          *matCellDef="let element"
          [class.resolved]="element.status === 'resolved'"
          [class.ignored]="element.status === 'ignored'"
        >
          {{ element.status }}
        </td>
      </ng-container>

      <ng-container matColumnDef="title">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Issue</th>
        <td
          mat-cell
          *matCellDef="let element"
          [class.resolved]="element.status === 'resolved'"
          [class.ignored]="element.status === 'ignored'"
        >
          <a [routerLink]="element.id">{{ element.title }}</a>
          <div>
            <span
              class="mat-caption"
              *ngIf="(oneProjectApplied$ | async) === false"
            >
              {{ element.projectSlug }}
            </span>
            <span class="mat-caption" *ngIf="true">
              <ng-container *ngIf="(oneProjectApplied$ | async) === false">
                &mdash;
              </ng-container>
              <time
                [dateTime]="element.firstSeen"
                [title]="element.firstSeen | date: 'medium'"
              >
                {{ element.firstSeen | date }}
              </time>
              <time
                *ngIf="element.firstSeen !== element.lastSeen"
                [dateTime]="element.lastSeen"
                [title]="element.lastSeen | date: 'medium'"
              >
                / {{ element.lastSeen | date }}
              </time>
            </span>
            <span
              class="mat-caption"
              *ngIf="element.type && element.type === 'csp'"
              ><span
                *ngIf="(oneProjectApplied$ | async) === false && element.type"
              >
                &mdash; </span
              >{{ element.type }} report</span
            >
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="pagination">
        <td mat-footer-cell *matFooterCellDef colspan="3" class="footer">
          <ng-container *ngIf="(loading$ | async) === false">
            <a
              [routerLink]="[]"
              [queryParams]="(previousParams$ | async) || {}"
              queryParamsHandling="merge"
              mat-button
              [disabled]="(hasPreviousPage$ | async) === false"
            >
              <mat-icon>keyboard_arrow_left</mat-icon>
            </a>
            <a
              [routerLink]="[]"
              [queryParams]="(nextParams$ | async) || {}"
              queryParamsHandling="merge"
              mat-button
              *ngIf="hasNextPage$ | async"
            >
              <mat-icon>keyboard_arrow_right</mat-icon>
            </a>
          </ng-container>
          <div *ngIf="loading$ | async" class="spinner-container">
            <mat-progress-spinner
              [diameter]="33"
              color="primary"
              mode="indeterminate"
            ></mat-progress-spinner>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="['actions']"></tr>
      <tr
        mat-header-row
        class="overlay"
        *matHeaderRowDef="displayedColumns"
      ></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      <tr mat-footer-row *matFooterRowDef="['pagination']"></tr>
    </table>
  </div>
</section>
